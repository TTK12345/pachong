# 知识库上传功能说明

## 功能概述

本系统新增了将爬取的文件上传到知识库的功能，支持批量选择文件并上传到指定的知识库进行解析和索引。

## 主要特性

- ✅ 支持批量选择文件上传
- ✅ 实时显示上传进度
- ✅ 支持多种文件格式（PDF、DOC、DOCX、TXT、HTML、WPS）
- ✅ 文件大小和类型验证
- ✅ 可配置的知识库API设置
- ✅ 详细的错误提示和成功反馈
- ✅ **新增** 支持选择是否立即解析文档
- ✅ **新增** 两种上传模式：仅上传或上传并解析

## 使用步骤

### 1. 配置知识库API

在 `knowledge_config.py` 文件中配置您的知识库系统信息：

```python
KNOWLEDGE_BASE_CONFIG = {
    "base_url": "https://your-knowledge-base.com",  # 替换为您的知识库API地址
    "authorization": "Bearer YOUR_TOKEN_HERE",      # 替换为您的访问令牌
    "app_id": "YOUR_APP_ID",                       # 替换为您的应用ID
    "app_sign": "YOUR_APP_SIGN",                   # 替换为您的应用签名
    # ... 其他配置
}
```

### 2. 使用上传功能

1. **启动系统**：运行 `python app.py` 启动爬虫系统
2. **查看文件**：在"已下载文件"标签页中查看已爬取的文件
3. **选择文件**：
   - 单个选择：勾选文件左侧的复选框
   - 批量选择：点击表头的复选框全选所有文件
4. **上传操作**：
   - 点击"上传到知识库"按钮
   - 在弹窗中选择目标知识库
   - 确认选择的文件列表
   - **选择上传模式**：
     * **仅上传到知识库（不解析）**：文件将上传但不会立即解析，可稍后手动解析
     * **上传并立即解析**：文件上传后自动开始解析，耗时更长但无需后续操作
   - 点击"开始上传"

### 3. 监控上传进度

- 上传过程中会显示实时进度条
- 显示当前上传的文件名和进度百分比
- 如果选择了"上传并解析"模式：
  - 先显示文件上传进度
  - 上传完成后自动开始解析进度
  - 解析完成后显示最终结果
- 上传完成后显示成功/失败统计

## 界面说明

### 文件列表页面

- **复选框列**：用于选择要上传的文件
- **全选按钮**：表头的复选框，支持全选/取消全选
- **上传按钮**：显示选中文件数量，只有选择文件后才可点击

### 上传配置弹窗

- **知识库选择**：下拉列表显示可用的知识库及其文档数量
- **文件列表**：显示已选择的文件，包含文件图标和名称
- **上传模式选择**：
  - 仅上传到知识库（不解析）- 默认选项，快速上传
  - 上传并立即解析 - 上传后自动解析，耗时较长
- **进度显示**：上传过程中的进度条和状态信息

## 支持的文件格式

| 格式 | 扩展名 | MIME类型 |
|------|---------|----------|
| PDF | .pdf | application/pdf |
| Word文档 | .doc | application/msword |
| Word文档 | .docx | application/vnd.openxmlformats-officedocument.wordprocessingml.document |
| 文本文件 | .txt | text/plain |
| 网页文件 | .html | text/html |
| WPS文档 | .wps | application/vnd.ms-works |

## 配置选项

### 文件限制配置

在 `knowledge_config.py` 中可以配置：

```python
"file_limits": {
    "max_size_mb": 100,  # 最大文件大小（MB）
    "allowed_types": [   # 支持的文件类型
        ".pdf", ".doc", ".docx", ".txt", ".html", ".wps"
    ]
}
```

### 超时设置

```python
"timeout": {
    "list": 30,      # 获取知识库列表超时时间（秒）
    "upload": 120,   # 上传文件超时时间（秒）
    "parse": 180     # 解析文档超时时间（秒）
}
```

## 错误处理

系统会处理以下常见错误：

- **网络错误**：API连接失败、超时等
- **文件错误**：文件不存在、文件过大、不支持的格式
- **认证错误**：无效的访问令牌或权限不足
- **服务器错误**：知识库API返回错误

所有错误都会显示详细的中文提示信息。

## 注意事项

1. **令牌安全**：请妥善保管您的API令牌，不要将其提交到公共代码仓库
2. **文件大小**：默认限制单个文件最大100MB，可在配置文件中调整
3. **网络环境**：确保服务器能够访问知识库API地址
4. **并发限制**：避免同时上传大量文件，建议分批上传
5. **解析时间**：选择"上传并解析"模式时，解析可能需要较长时间，请耐心等待
6. **解析失败**：如果解析失败，文件仍然会保存在知识库中，可稍后手动重新解析

## 自定义知识库系统

如果您使用其他知识库系统，可以修改 `knowledge_config.py` 和 `app.py` 中的API调用逻辑：

1. 修改API端点URL
2. 调整请求头格式
3. 更新认证方式
4. 适配响应数据格式

## 故障排除

### 常见问题

**Q: 知识库列表加载失败**
A: 检查网络连接和API配置，确认令牌是否有效

**Q: 文件上传失败**  
A: 检查文件格式、大小是否符合要求，确认知识库是否有上传权限

**Q: 上传速度慢**
A: 可能是网络问题或文件较大，请耐心等待或分批上传

**Q: 文档解析失败**
A: 检查文档格式是否支持，或稍后在知识库中手动重新解析

**Q: 应该选择哪种上传模式？**
A: 如果急需使用文档内容，选择"上传并解析"；如果只是批量保存，选择"仅上传"即可

### 调试方法

1. 查看浏览器控制台的错误信息
2. 检查后端日志输出
3. 验证配置文件的参数设置
4. 测试知识库API是否正常工作

## 技术支持

如遇到问题，请：
1. 查看系统日志文件
2. 检查配置文件设置
3. 验证网络连接状态
4. 联系系统管理员 